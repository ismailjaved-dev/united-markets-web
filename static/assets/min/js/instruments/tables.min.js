window.App=new Vue({el:".markets-table-container",data:{cfg:{markets:marketPricesWidgetConfig.markets,instruments:marketPricesWidgetConfig.instruments,refreshInterval:marketPricesWidgetConfig.refreshInterval||1500,static:marketPricesWidgetConfig.static,delayed:marketPricesWidgetConfig.delayed},market:marketPricesWidgetConfig.market||"forex",instruments:[],searchPlaceholder:"",searchTerm:"",searchInProgress:!1,searchResults:-1,interval:null,tickerNameCache:{},priceCache:{}},methods:{setMarket(t){this.searchInProgress||(this.market=t,this.searchTerm="",this.searchResults=-1,marketPricesWidgetConfig.spreads?(this.tickers=marketPricesWidgetConfig.spreads.filter(t=>t.market===this.market),this.tickersSort=((t,e)=>this.tickers.indexOf(t.ticker)-this.tickers.indexOf(e.ticker))):(this.tickers=this.getTickerList(),this.tickersSort=((t,e)=>this.tickers.indexOf(t.ticker)-this.tickers.indexOf(e.ticker))),clearInterval(this.interval),this.interval=0,this.instruments.length=0,this.searchInProgress=!0,this.tickers.length&&(marketPricesWidgetConfig.spreads?marketPricesService.getInstrumentsInfoFromObject(this.tickers,"PRO").then(t=>{this.fetchPrices(t,this.tickersSort)}):marketPricesService.getInstrumentsInfo(this.tickers,"PRO").then(t=>{this.fetchPrices(t,this.tickersSort)})))},formatDiff(t){if((t=Math.abs(t))<1){for(;t<1;)t*=10;t/=10}return Math.round(100*t)/100},searchInstruments(){this.searchTerm.replace(/[\W\s\n\r\t]/g,"").length?(this.instruments.length=0,this.interval&&(clearInterval(this.interval),this.interval=0),this.searchTerm.length>=3&&(this.searchInProgress=!0,this.searchResults=-1,instrumentsService.search(this.searchTerm,this.market).then(t=>this.fetchPrices(t,this.tickersSort)))):this.setMarket(this.market)},fetchPrices(t,e=(()=>0)){this.searchResults=t.length,this.interval&&(clearInterval(this.interval),this.interval=0);const s=()=>{marketPricesService.getInstrumentsPrices(t.map(({id:t})=>t)).then(s=>{this.instruments=s.map(e=>({...t.find(t=>t.id===e.instrumentId),...e})).sort(e),this.instruments.forEach(t=>{const e=this.tickers.find(e=>e.ticker===t.ticker);e&&(t.spread=e.spread,t.spread2=e.spread2)}),this.instruments.forEach(t=>{const{ticker:e,ask:s,bid:i}=t;let r=this.priceCache[e];if(this.cfg.delayed.includes(e)){if(this.priceCache[e]||(r=this.priceCache[e]=[]),r.push({instrument:Object.assign({},t),death:new Date(Date.now()+9e5)}),new Date>=r[0].death){const t=r.shift();r[0].instrument.prevAsk=t.instrument.ask,r[0].instrument.prevBid=t.instrument.bid}Object.assign(t,r[0].instrument)}else Object.assign(t,r),this.priceCache[e]={prevBid:i,prevAsk:s}}),this.searchInProgress=!1})};s(),this.cfg.static||(this.interval=setInterval(s,this.cfg.refreshInterval))},getTickerList(){return this.cfg.instruments?((this.cfg.instruments.find(t=>t.market===this.market)||{}).tickers||"").split(","):[]},setup(){this.cfg.instruments&&this.cfg.instruments.forEach(t=>{this.cfg.markets[t.market]&&(this.cfg.markets[t.market]=t.title)}),this.setMarket(this.market)},refreshList(){this.cfg.instruments=marketPricesWidgetConfig.instruments,this.setup()}},mounted(){this.setup()}});